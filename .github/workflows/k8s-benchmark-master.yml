name: 'K8s Benchmark Master Flow'

on:
  workflow_dispatch:
    inputs:
      demo_mode:
        description: 'Run in demo mode (installs grafana)'
        required: false
        default: false
        type: boolean
      csp:
        description: 'Select Cloud Service Provider'
        required: true
        default: 'ovh'
        type: choice
        options:
          - azure
          - ovh
          - aws
  # push:
  #   branches:
  #     - master

jobs:
  init_results:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Initialize results.json
        env:
          CSP: ${{ github.event.inputs.csp }}
        run: python monitoring/init_results_json.py
      - name: Upload benchmark results artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results.json

  infra:
    uses: ./.github/workflows/terraform.yml
    secrets: inherit
    with:
      csp: ${{ github.event.inputs.csp || 'ovh' }}

  metrics_server:
    needs: infra
    uses: ./.github/workflows/metrics-server-template.yml
    secrets: inherit

  monitoring:
    if: ${{ github.event.inputs.demo_mode == 'true' }}
    needs: metrics_server
    uses: ./.github/workflows/monitoring-template.yml
    secrets: inherit

  argocd:
    needs: metrics_server
    uses: ./.github/workflows/argocd-template.yml
    secrets: inherit
  
  app_ci:
    needs: argocd
    uses: ./.github/workflows/app-ci-template.yml
    secrets: inherit

  measure_external_ip:
    needs: app_ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download kubeconfig artifact
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig
      - name: Download benchmark results artifact
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: .
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Run external IP measurement script
        run: python monitoring/measure_external_ip.py
      - name: Upload updated benchmark results artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results.json

  locust:
    needs: app_ci
    uses: ./.github/workflows/locust-template.yml
    secrets: inherit
    with:
      demo_mode: ${{ github.event.inputs.demo_mode == 'true' }}

  measure_scaleup:
    needs: locust
    if: ${{ github.event.inputs.demo_mode == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download benchmark results artifact
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: .
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install kubernetes
      - name: Download kubeconfig artifact
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig
          path: .
      - name: Set KUBECONFIG env var
        run: echo "KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig.yaml" >> $GITHUB_ENV
      - name: Run scale-up measurement script
        run: python monitoring/measure_scaleup.py
      - name: Upload updated benchmark results artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results.json
