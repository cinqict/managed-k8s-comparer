name: 'Build and Deploy Dummy App'
on:
  workflow_call:
jobs:
  app_ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push Dummy App Image
        uses: docker/build-push-action@v5
        with:
          context: ./dummy-app
          file: ./dummy-app/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-app:latest
      - name: Download kubeconfig artifact
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig
          path: .
      - name: Download DB credentials
        uses: actions/download-artifact@v4
        with:
          name: pgsql-credentials
          path: .
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      - name: Create pgsql-credentials Secret
        run: |
          kubectl --kubeconfig=kubeconfig.yaml delete secret pgsql-credentials || true
          kubectl --kubeconfig=kubeconfig.yaml create secret generic pgsql-credentials \
            --from-file=host=pgsql_host.txt \
            --from-file=port=pgsql_port.txt \
            --from-file=user=pgsql_username.txt \
            --from-file=password=pgsql_password.txt \
            --from-file=dbname=pgsql_dbname.txt
      - name: Deploy Dummy App via ArgoCD
        run: |
          kubectl --kubeconfig=kubeconfig.yaml -n argocd delete application dummy-app --ignore-not-found
          sleep 5
          kubectl --kubeconfig=kubeconfig.yaml apply -f ./dummy-app/argocd-app.yaml
      - name: Restart Dummy App Deployment
        run: |
          kubectl --kubeconfig=kubeconfig.yaml -n default rollout restart deployment dummy-app
